# CacheBot

Telegram бот для сопровождения P2P сделок USDT ⇄ RUB с учетом комиссии и интеграцией Crypto Pay. Продавец создает сделку, покупатель резервирует её, оплачивает счет в USDT и получает инструкции по передаче наличных рублей. После подтверждения платежа баланс продавца в CacheBot пополняется автоматически.
## Возможности
- Ролевое меню при старте: продажа USDT (продавец) или подача заявки на роль мерчанта.
- Постоянная клавиатура с единственной кнопкой «Меню», которая разворачивает действия согласно роли пользователя.
- Создание сделок через кнопку «Создать сделку» с автоматическим расчетом суммы в USDT по актуальному курсу и комиссии.
- Просмотр доступных сделок («Доступные сделки») и бронь предложения с генерацией счета Crypto Pay.
- Автоотмена сделки, если счет не оплачен в течение тайм-аута (по умолчанию 15 минут).
- Отслеживание статуса счетов через Crypto Pay API: бот опрашивает счета и параллельно принимает вебхуки, чтобы сразу реагировать на оплату.
- Быстрый доступ к балансу и собственным сделкам через кнопки меню («Баланс», «Мои сделки»), а также к отмене/завершению сделки.
- Админ-кнопки «Настроить курс» и «Отметить оплату» для ручного изменения параметров и подтверждения платежей.
- Опросник для будущих мерчантов с чек-листом банков, подтверждением рисков и загрузкой скринов; заявки сохраняются, доступны владельцам по кнопке и могут быть приняты/отклонены в один клик.

## Запуск
1. Установите зависимости:
   ```bash
   pip install -e .
   ```
2. Создайте файл `.env` на основе `.env.example` и заполните переменные:
   - `TELEGRAM_BOT_TOKEN` — токен Telegram-бота.
   - `CRYPTO_PAY_TOKEN` — токен Crypto Pay (можно оставить пустым для тестов, тогда счета будут эмулироваться).
   - `ADMIN_USER_IDS` — список ID администраторов через запятую.
   - `DEFAULT_USD_RATE` и `FEE_PERCENT` — стартовые значения курса (сколько RUB получаем за 1 USDT) и комиссии.
   - `STATE_FILE` — путь к файлу состояния (по умолчанию `var/state.json`).
   - `KB_API_URL`/`KB_API_TOKEN` — эндпоинт и токен сервиса, куда нужно зачислять рублевый баланс (если не заданы, операции просто логируются).
   - `CRYPTO_PAY_WEBHOOK_HOST`/`PORT`/`PATH` — адрес HTTP-сервера, где бот принимает вебхуки Crypto Pay (по умолчанию `0.0.0.0:8080/crypto-pay/webhook`). Его нужно прокинуть наружу (например, через nginx) и указать в настройках Crypto Pay.
   - `CRYPTO_PAY_WEBHOOK_SECRET` — секрет для подписи вебхука (`X-Crypto-Pay-Signature`). Если не задан, используется токен Crypto Pay.
3. Запустите бота:
   ```bash
   python -m cachebot.main
   ```

## Логика сделок
1. **Выбор роли** — пользователь нажимает «Продажа USDT» (режим продавца) или подает заявку «Стать мерчантом». Пока заявка не одобрена, доступен только режим продавца и создание сделок.
2. **Продавец** выбирает в меню «Создать сделку» и вводит сумму RUB (или USDT). Бот показывает расчет по текущему курсу и комиссии. После подтверждения создается сделка со статусом `open`.
3. **Покупатель (мерчант)** после одобрения заявки нажимает «Доступные сделки», выбирает нужное предложение и нажимает «Взять сделку». Бот генерирует счет Crypto Pay, прикрепляет его к сделке и уведомляет обе стороны. Статус меняется на `reserved`, а таймер продлевается еще на 15 минут.
4. **Оплата** отслеживается воркером `invoice_watcher` и вебхуками Crypto Pay. Как только приходит статус `paid`, бот переводит сделку в статус `paid`, автозачисляет рублевый баланс продавцу и уведомляет участников. Если Crypto Pay токен не задан, администратор может воспользоваться кнопкой «Отметить оплату».
5. **Завершение** — после фактического получения наличных продавец или администратор выбирает «✅ Завершить сделку», указывает ID и подтверждает закрытие (статус `completed`).
6. **Отмена** — продавец/покупатель может выбрать «⛔️ Отменить сделку» и указать ID. Если таймер истекает, сделка автоматически помечается как `expired`.

## Хранение данных
Все данные (сделки, балансы, настройки курса) сохраняются в JSON-файле `STATE_FILE`. База данных не требуется. Для «чистого» состояния достаточно удалить этот файл.

## Дальнейшие шаги
- Добавить веб-интерфейс или рассылку в канал для публикации новых сделок.
- Подключить внешний источник курсов или UI для управления ими.
- Расширить интеграцию KB API (проверка статуса, история).
